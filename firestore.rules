
/**
 * Core Philosophy: This ruleset implements a security model for a public-facing content management system (CMS).
 * The primary goal is to make content like services, FAQs, blog posts, and success stories publicly readable by anyone,
 * while strictly controlling all data modification. Due to the absence of a defined administrator role or document
 * ownership fields in the data model, all write operations (create, update, delete) on content are disabled by default.
 * This creates a secure, read-only state for public data.
 *
 * Data Structure: The database uses a flat hierarchy of top-level collections for different types of content
 * (e.g., /services, /faqs, /blog_posts). Sensitive data, such as job applications and referrals, is also stored
 * in separate top-level collections to enforce stricter access controls. There are no user-specific subcollections.
 *
 * Key Security Decisions:
 * - Public Read-Only Content: Collections like `services`, `faqs`, `success_stories`, `blog_posts`, `locations`, and `universities` are publicly
 *   readable by any user, including unauthenticated ones.
 * - Locked-Down Writes: All write operations on public content are denied (`if false;`) as a secure default.
 *   A placeholder function `isContentAdmin()` is included to show where
 *   admin-only logic should be implemented once an admin system is in place.
 * - "Write-Once" Collections for Submissions: Collections like `job_applications`, `referrals`, and `consultations` contain sensitive
 *   information. They are configured to allow anyone to create (submit) a document but prevent anyone from reading,
 *   updating, or deleting them via the client. This allows data to be collected securely for backend processing.
 *
 * Denormalization for Authorization: This principle is acknowledged but not currently applied, as the data model
 * does not yet include features like user ownership or collaborative documents that would require denormalized
 * authorization fields (e.g., an `ownerId` on a blog post).
 *
 * Structural Segregation: The use of separate collections for each data entity (e.g., `/services`, `/blog_posts`)
 * is a core design choice. This ensures that a simple, uniform security policy can be applied to all documents
 * of the same type, which is more secure and performant than mixing public and private documents in one collection.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to improve readability and maintainability of the rules.

    /**
     * Placeholder for content administrator role check.
     * Currently returns false to lock down all write operations on public content.
     * TODO: Implement a real admin check, e.g., by looking up a user's custom claims.
     * function isContentAdmin() {
     *   return request.auth.token.isAdmin == true;
     * }
     */
    function isContentAdmin() {
      // For development, we are temporarily allowing any authenticated user to write.
      // In a production app, this should be replaced with a proper admin check.
      return request.auth != null;
    }

    /**
     * @description Controls access to the 'services' collection.
     * @path /services/{serviceId}
     * @allow (get, list) any user, authenticated or not, can read service information.
     * @deny (create, update, delete) all users are blocked from modifying services.
     * @principle Public read-only access for marketing content. Writes are locked pending an admin implementation.
     */
    match /services/{serviceId} {
      allow get, list: if true;
      allow create, update, delete: if isContentAdmin();
    }

    /**
     * @description Controls access to the 'faqs' collection.
     * @path /faqs/{faqId}
     * @allow (get, list) any user, authenticated or not, can read FAQs.
     * @deny (create, update, delete) all users are blocked from modifying FAQs.
     * @principle Public read-only access for informational content. Writes are locked pending an admin implementation.
     */
    match /faqs/{faqId} {
      allow get, list: if true;
      allow create, update, delete: if isContentAdmin();
    }

    /**
     * @description Controls access to the 'success_stories' collection.
     * @path /success_stories/{successStoryId}
     * @allow (get, list) any user, authenticated or not, can read success stories.
     * @deny (create, update, delete) all users are blocked from modifying success stories.
     * @principle Public read-only access for marketing content. Writes are locked pending an admin implementation.
     */
    match /success_stories/{successStoryId} {
      allow get, list: if true;
      allow create, update, delete: if isContentAdmin();
    }

    /**
     * @description Controls access to the 'blog_posts' collection.
     * @path /blog_posts/{blogPostId}
     * @allow (get, list) any user, authenticated or not, can read blog posts.
     * @deny (create, update, delete) all users are blocked from modifying blog posts.
     * @principle Public read-only access for content. Writes are locked pending an admin or author ownership implementation.
     */
    match /blog_posts/{blogPostId} {
      // CRITICAL: Cannot implement owner-only writes. The 'BlogPost' entity is missing a UID-based 'authorId' field.
      allow get, list: if true;
      allow create, update, delete: if isContentAdmin();
    }

    /**
     * @description Controls access to the 'job_openings' collection.
     * @path /job_openings/{jobOpeningId}
     * @allow (get, list) any user, authenticated or not, can read job openings.
     * @deny (create, update, delete) all users are blocked from modifying job openings.
     * @principle Public read-only access for content. Writes are locked pending an admin or author ownership implementation.
     */
    match /job_openings/{jobOpeningId} {
      allow get, list: if true;
      allow create, update, delete: if isContentAdmin();
    }

    /**
     * @description Controls access to the 'job_applications' collection. This is a "write-once" collection.
     * @path /job_applications/{jobApplicationId}
     * @allow (create) any user can submit a job application.
     * @deny (get, list, update, delete) all users are blocked from reading or modifying submitted applications to protect PII.
     * @principle Secures sensitive user-submitted data by allowing creation but preventing any client-side read or modification access.
     */
    match /job_applications/{jobApplicationId} {
      allow create: if true;
      allow get, list, update, delete: if false;
    }

    /**
     * @description Controls access to the 'referrals' collection. This is a "write-once" collection for the public.
     * @path /referrals/{referralId}
     * @allow (create) any user can submit a referral.
     * @allow (list, update) only content admins can view and update the status of referrals.
     * @deny (get, delete) all users are blocked from reading a single referral directly or deleting them.
     * @principle Secures sensitive user-submitted data by allowing creation but restricting read/modification to admins.
     */
    match /referrals/{referralId} {
      allow create: if true;
      allow list, update: if isContentAdmin();
      allow get, delete: if false;
    }

    /**
     * @description Controls access to the 'contacts' collection. This is a "write-once" collection.
     * @path /contacts/{contactId}
     * @allow (create) any user can submit a contact message.
     * @allow (list) only content admins can view submitted messages.
     * @deny (get, update, delete) all users are blocked from reading or modifying submitted messages.
     * @principle Secures user-submitted data by allowing creation but restricting read access to admins.
     */
    match /contacts/{contactId} {
      allow create: if true;
      allow list: if isContentAdmin();
      allow get, update, delete: if false;
    }

    /**
     * @description Controls access to the 'consultations' collection. This is a "write-once" collection.
     * @path /consultations/{consultationId}
     * @allow (create) any user can submit a consultation request.
     * @allow (list) only content admins can view submitted requests.
     * @deny (get, update, delete) all users are blocked from reading or modifying submitted requests to protect PII.
     * @principle Secures sensitive user-submitted data by allowing creation but restricting read access to admins.
     */
    match /consultations/{consultationId} {
        allow create: if true;
        allow list: if isContentAdmin();
        allow get, update, delete: if false;
    }

    /**
     * @description Controls access to the 'locations' collection.
     * @path /locations/{locationId}
     * @allow (get, list) Publicly readable to display contact info.
     * @deny (create, update, delete) Only admins can manage office locations.
     * @principle Allows public read for contact details while securing write access.
     */
    match /locations/{locationId} {
        allow get, list: if true;
        allow create, update, delete: if isContentAdmin();
    }

    /**
     * @description Controls access to the 'universities' collection.
     * @path /universities/{universityId}
     * @allow (get, list) Publicly readable to display partner logos.
     * @deny (create, update, delete) Only admins can manage university partners.
     * @principle Allows public read for homepage slider while securing write access.
     */
    match /universities/{universityId} {
        allow get, list: if true;
        allow create, update, delete: if isContentAdmin();
    }
  }
}
